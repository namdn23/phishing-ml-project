# Xóa tất cả dấu cách nằm ngay trước dấu phẩy
sed -i 's/ ,/,/g' extraction_checkpoint.csv

# Kiểm tra lại 5 dòng đầu xem đã sát nhau chưa
head -n 5 extraction_checkpoint.csv
V10_HTTP_Extraction_Success,V11_WHOIS_Extraction_Success,V1_PHash_Distance,V2_Layout_Similarity,V6_JS_Entropy,V7_Text_Readability_Score,V8_Total_IFrames,V9_Has_Hidden_IFrame,V5_TLS_Issuer_Reputation,V3_Domain_Age_Days,V4_DNS_Volatility_Count,Is_Top_1M_Domain,V22_IP_Subdomain_Pattern,V23_Entropy_Subdomain,URL_KEY,Alarm_System_Error,Alarm_Capture_Failed,Alarm_Empty_Content


sed -i '1s/.*/V10_HTTP_Extraction_Success,V11_WHOIS_Extraction_Success,V1_PHash_Distance,V2_Layout_Similarity,V6_JS_Entropy,V7_Text_Readability_Score,V8_Total_IFrames,V9_Has_Hidden_IFrame,V5_TLS_Issuer_Reputation,V3_Domain_Age_Days,V4_DNS_Volatility_Count,Is_Top_1M_Domain,V22_IP_Subdomain_Pattern,V23_Entropy_Subdomain,Alarm_System_Error,Alarm_Capture_Failed,Alarm_Empty_Content,URL_KEY/' extraction_checkpoint.csv
python3 -c "
import sys
fname = 'extraction_checkpoint.csv'
with open(fname, 'r') as f:
    lines = f.readlines()

header = 'V10_HTTP_Extraction_Success,V11_WHOIS_Extraction_Success,V1_PHash_Distance,V2_Layout_Similarity,V6_JS_Entropy,V7_Text_Readability_Score,V8_Total_IFrames,V9_Has_Hidden_IFrame,V5_TLS_Issuer_Reputation,V3_Domain_Age_Days,V4_DNS_Volatility_Count,Is_Top_1M_Domain,V22_IP_Subdomain_Pattern,V23_Entropy_Subdomain,Alarm_System_Error,Alarm_Capture_Failed,Alarm_Empty_Content,URL_KEY\n'

new_lines = [header]
for line in lines[1:]:
    parts = line.strip().split(',')
    # Loại bỏ khoảng trắng thừa ở mỗi phần
    parts = [p.strip() for p in parts]
    if len(parts) >= 15:
        # Giả định 3 cột cuối hiện tại đang là URL_KEY, 0, 0, 0 (do bạn điền nhầm)
        # Hoặc đang bị lệch. Chúng ta sẽ tái cấu trúc:
        # [Các đặc trưng 0-13] + [3 cột Alarm cuối] + [Cột URL]
        alarms = parts[-3:]
        url = parts[-4]
        features = parts[:14]
        new_line = ','.join(features + alarms + [url]) + '\n'
        new_lines.append(new_line)

with open(fname, 'w') as f:
    f.writelines(new_lines)
print('✅ Đã tái cấu trúc file thành công!')
"
