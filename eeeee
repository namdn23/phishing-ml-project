import pandas as pd
import asyncio
import random
import os

from playwright.async_api import async_playwright
from playwright_stealth import stealth

INPUT_FILE = "Dataset_Ready_to_Train.csv"
NUM_TEST_SAMPLES = 5


async def check_bypass_level(url, browser):
    results = {"URL": url}

    levels = [
        ("Level_1_Basic", False, False),
        ("Level_2_Stealth_Behavior", True, True)
    ]

    for name, use_stealth, use_behavior in levels:
        context = await browser.new_context(
            user_agent=(
                "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                "AppleWebKit/537.36 (KHTML, like Gecko) "
                "Chrome/120.0.0.0 Safari/537.36"
            ),
            viewport={"width": 1366, "height": 768},
            locale="en-US"
        )

        page = await context.new_page()

        # ✅ Stealth phải gọi SAU khi new_page
        if use_stealth:
            await stealth(page)

            # fallback stealth cho Kali (rất quan trọng)
            await page.add_init_script("""
                Object.defineProperty(navigator, 'webdriver', {
                    get: () => undefined
                });
            """)

        try:
            print(f"[+] Testing {name} -> {url}")

            if use_behavior:
                await page.set_extra_http_headers({
                    "Referer": "https://www.google.com/"
                })

            await page.goto(
                url,
                wait_until="domcontentloaded",
                timeout=40000
            )

            if use_behavior:
                await asyncio.sleep(random.uniform(3, 6))
                await page.mouse.move(
                    random.randint(100, 500),
                    random.randint(100, 500)
                )
                await page.mouse.wheel(0, random.randint(300, 800))

            title = (await page.title()).lower()
            html = (await page.content()).lower()

            # ❗ Giảm false positive
            is_blocked = (
                "just a moment" in title
                or "checking your browser" in html
                or "cloudflare" in html
            )

            results[name] = "SUCCESS" if not is_blocked else "BLOCKED"

        except Exception as e:
            results[name] = f"ERROR: {str(e)[:40]}"

        finally:
            await page.close()
            await context.close()

    return results


async def main():
    if not os.path.exists(INPUT_FILE):
        print(f"❌ Không tìm thấy file {INPUT_FILE}")
        return

    df = pd.read_csv(INPUT_FILE)
    urls = df.sample(n=min(NUM_TEST_SAMPLES, len(df)))["URL"].tolist()

    print(f"\n--- BẮT ĐẦU KIỂM TRA {len(urls)} MẪU ---\n")

    async with async_playwright() as p:
        browser = await p.chromium.launch(
            headless=False,
            args=[
                "--disable-blink-features=AutomationControlled",
                "--no-sandbox",
                "--disable-dev-shm-usage"
            ]
        )

        results = []
        for url in urls:
            res = await check_bypass_level(url, browser)
            results.append(res)

        await browser.close()

    df_res = pd.DataFrame(results)
    print("\n=== KẾT QUẢ ===")
    print(df_res)

    df_res.to_csv("test_summary.csv", index=False)
    print("\n✔ Đã lưu test_summary.csv")


if __name__ == "__main__":
    asyncio.run(main())
