import pandas as pd
import numpy as np
import math
import re
import asyncio
import os
import time
import random
from datetime import datetime, timedelta
from urllib.parse import urlparse
from playwright.async_api import async_playwright
from concurrent.futures import ProcessPoolExecutor

# =========================================================
# 1. Cáº¤U HÃŒNH CHO MÃY 27GB RAM
# =========================================================
INPUT_FILE = "Dataset_Ready_to_Train.csv"
OUTPUT_FILE = "Dataset_18_Features_Final.csv"
LOG_FILE = "detailed_process.log"

NUM_PROCESSES = 10         # Cháº¡y 10 tiáº¿n trÃ¬nh song song
PAGES_PER_PROCESS = 5      # Má»—i tiáº¿n trÃ¬nh má»Ÿ 5 tab (Tá»•ng cá»™ng 50 tabs)
TIMEOUT = 60000           

# --- HÃ m tÃ ng hÃ¬nh (Bypass Cloudflare) ---
async def apply_stealth(page):
    await page.add_init_script("""
        Object.defineProperty(navigator, 'webdriver', { get: () => false });
        window.chrome = { runtime: {} };
        Object.defineProperty(navigator, 'languages', { get: () => ['en-US', 'en'] });
    """)

# ... (HÃ m extract_static vÃ  calculate_entropy giá»¯ nguyÃªn) ...

# =========================================================
# 2. HÃ€M Xá»¬ LÃ URL (Cáº¢I TIáº¾N LOG & SPEED)
# =========================================================
async def process_url(url, label, context, semaphore, log_file):
    static_data = extract_static(url) #
    dynamic_data = {f: 0.5 for f in ['Outlink_Ratio', 'HasExternalFormSubmit', 'HasPasswordField', 'DomainTitleMatchScore', 
                                    'HasSocialNet', 'HasCopyrightInfo', 'HasDescription', 'V9_Has_Hidden_IFrame', 
                                    'V5_TLS_Issuer_Reputation', 'V4_DNS_Volatility_Count']} #
    status, reason = "FAILED", "INIT"

    async with semaphore:
        page = await context.new_page()
        await apply_stealth(page) #
        try:
            await page.set_extra_http_headers({"Referer": "https://www.google.com/"}) #
            await page.goto(url, timeout=TIMEOUT, wait_until="domcontentloaded") #
            
            # VÆ°á»£t WAF báº±ng hÃ nh vi
            await asyncio.sleep(random.uniform(3, 6)) #
            
            content = (await page.content()).lower()
            title = (await page.title()) or ""

            if "just a moment" in title.lower() or "cloudflare" in content:
                reason = "Cloudflare Blocked"
            else:
                # TrÃ­ch xuáº¥t Dynamic
                domain = urlparse(url).netloc.lower()
                v9_val = 0
                for f in page.frames[1:]:
                    try:
                        el = await f.frame_element()
                        if el and not await el.is_visible(): v9_val = 1; break
                    except: continue

                dynamic_data.update({
                    'V9_Has_Hidden_IFrame': v9_val,
                    'HasPasswordField': 1 if await page.query_selector('input[type="password"]') else 0,
                    'DomainTitleMatchScore': 1 if domain.split('.')[0] in title.lower() else 0,
                    'V5_TLS_Issuer_Reputation': 1 if url.startswith('https') else 0
                })
                status, reason = "SUCCESS", f"OK: {title[:15]}"

        except Exception as e:
            reason = f"ERR: {str(e).splitlines()[0][:40]}"
        finally:
            await page.close()
            
    # GHI LOG NGAY Láº¬P Tá»¨C (Flush)
    log_line = f"[{datetime.now().strftime('%H:%M:%S')}] {status} | {url} | {reason}\n"
    with open(log_file, "a", encoding="utf-8") as f:
        f.write(log_line)
        f.flush()
    
    return {**static_data, **dynamic_data, 'URL': url, 'label': label}

# =========================================================
# 3. QUáº¢N LÃ ÄA LUá»’NG & ETA
# =========================================================
async def run_batch(df_batch):
    async with async_playwright() as p:
        # Táº¯t Sandbox Ä‘á»ƒ tá»‘i Æ°u tá»‘c Ä‘á»™ trÃªn Kali
        browser = await p.chromium.launch(headless=False, args=['--no-sandbox', '--disable-setuid-sandbox'])
        context = await browser.new_context(user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0")
        semaphore = asyncio.Semaphore(PAGES_PER_PROCESS)
        tasks = [process_url(row['URL'], row['label'], context, semaphore, LOG_FILE) for _, row in df_batch.iterrows()]
        results = await asyncio.gather(*tasks)
        await browser.close()
        return results #

def process_entry(df_batch):
    try: return asyncio.run(run_batch(df_batch))
    except: return [] #

if __name__ == "__main__":
    start_all = time.time()
    df_all = pd.read_csv(INPUT_FILE)
    
    # Checkpoint (Bá» qua URL Ä‘Ã£ cÃ³ trong log)
    processed_urls = set()
    if os.path.exists(LOG_FILE):
        with open(LOG_FILE, "r") as f:
            for line in f:
                parts = line.split(" | ")
                if len(parts) > 1: processed_urls.add(parts[1].strip())

    df_todo = df_all[~df_all['URL'].isin(processed_urls)]
    total_todo = len(df_todo)
    print(f"ğŸš€ 27GB RAM Detect: Cháº¡y {NUM_PROCESSES} luá»“ng x {PAGES_PER_PROCESS} tabs.")

    # Batch lá»›n hÆ¡n Ä‘á»ƒ giáº£m cÃ´ng sá»©c khá»Ÿi Ä‘á»™ng browser
    batch_size = NUM_PROCESSES * 20 
    for i in range(0, total_todo, batch_size):
        current_batch = df_todo.iloc[i : i + batch_size]
        sub_batches = [b for b in np.array_split(current_batch, NUM_PROCESSES) if not b.empty]
        
        with ProcessPoolExecutor(max_workers=NUM_PROCESSES) as executor:
            futures = [executor.submit(process_entry, sub_batches[p]) for p in range(len(sub_batches))]
            batch_results = []
            for fut in futures: batch_results.extend(fut.result())
        
        if batch_results:
            df_res = pd.DataFrame(batch_results)
            df_res.to_csv(OUTPUT_FILE, mode='a', index=False, header=not os.path.exists(OUTPUT_FILE))
        
        # Dá»± bÃ¡o thá»i gian thá»±c táº¿
        done = i + len(current_batch)
        speed = done / (time.time() - start_all)
        eta = str(timedelta(seconds=int((total_todo - done) / speed))) if speed > 0 else "N/A"
        print(f"âœ… ÄÃ£ xong: {done}/{total_todo} | Speed: {speed:.2f} URL/s | ETA: {eta}")
