import pandas as pd
import requests
import concurrent.futures
import time
import sys
import os
import warnings

# --- Cáº¤U HÃŒNH ---
INPUT_FILE = 'urldata_old_121k.csv'   # <--- Äá»”I TÃŠN FILE Cá»¦A Báº N á» ÄÃ‚Y
OUTPUT_FILE = 'urldata_live_ready.csv' # File káº¿t quáº£ Ä‘á»ƒ Ä‘em Ä‘i trÃ­ch xuáº¥t
MAX_WORKERS = 100                     # QuÃ©t 100 luá»“ng cho nhanh
TIMEOUT = 3                           # 3s khÃ´ng tráº£ lá»i lÃ  coi nhÆ° cháº¿t

# Táº¯t cáº£nh bÃ¡o SSL
warnings.filterwarnings('ignore')

def check_alive(row):
    """Kiá»ƒm tra URL sá»‘ng hay cháº¿t"""
    url = str(row.get('url', '')).strip()
    label = row.get('label', '') # Láº¥y nhÃ£n cÅ© Ä‘á»ƒ thá»‘ng kÃª
    
    if not url: return None
    if not url.startswith(('http://', 'https://')):
        url = 'http://' + url
        
    try:
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36'}
        # 1. Thá»­ HEAD request (Nhanh)
        response = requests.head(url, headers=headers, timeout=TIMEOUT, allow_redirects=True, verify=False)
        if response.status_code < 400:
            return {'url': url, 'label': label}
            
        # 2. Thá»­ GET request (Náº¿u HEAD bá»‹ cháº·n)
        if response.status_code >= 400:
             response = requests.get(url, headers=headers, timeout=TIMEOUT, stream=True, verify=False)
             if response.status_code < 400:
                 return {'url': url, 'label': label}
    except:
        pass 
    return None

def analyze_stats(df):
    """HÃ m thá»‘ng kÃª sá»‘ lÆ°á»£ng Legit/Phishing"""
    print("\n" + "="*50)
    print("ğŸ“Š BÃO CÃO Sá» LÆ¯á»¢NG DATA CÃ’N Sá»NG")
    print("="*50)
    
    # Chuáº©n hÃ³a nhÃ£n vá» chá»¯ thÆ°á»ng Ä‘á»ƒ Ä‘áº¿m cho chuáº©n
    df['label_norm'] = df['label'].astype(str).str.lower()
    
    total = len(df)
    
    # Äáº¿m Phishing (CÃ¡c biáº¿n thá»ƒ bad, 1, phishing)
    phishing_count = len(df[df['label_norm'].isin(['bad', '1', 'phishing', 'malicious'])])
    
    # Äáº¿m Legit (CÃ¡c biáº¿n thá»ƒ good, 0, benign, legitimate)
    legit_count = len(df[df['label_norm'].isin(['good', '0', 'benign', 'legitimate'])])
    
    # Nhá»¯ng nhÃ£n láº¡ (náº¿u cÃ³)
    unknown = total - phishing_count - legit_count
    
    print(f"ğŸŸ¢ LEGIT (Sáº¡ch):    {legit_count:,} ({legit_count/total*100:.1f}%)")
    print(f"ğŸ”´ PHISHING (Báº©n): {phishing_count:,} ({phishing_count/total*100:.1f}%)")
    
    if unknown > 0:
        print(f"âšª KHÃC (Unknown):  {unknown:,}")
        
    print("-" * 50)
    print(f"ğŸ‘‰ Tá»”NG Cá»˜NG:      {total:,} dÃ²ng")
    print("="*50)
    
    # Cáº£nh bÃ¡o náº¿u máº¥t cÃ¢n báº±ng
    if phishing_count < 1000:
        print("\nâš ï¸  Cáº¢NH BÃO: Sá»‘ lÆ°á»£ng web Phishing cÃ²n sá»‘ng QUÃ ÃT!")
        print("   -> Báº¡n cáº§n lÃªn OpenPhish/PhishTank táº£i thÃªm data má»›i gáº¥p.")
        print("   -> Náº¿u train vá»›i bá»™ nÃ y, model sáº½ bá»‹ 'Há»c váº¹t' (Bias) theo web sáº¡ch.")
    else:
        print("\nâœ… Dá»¯ liá»‡u khÃ¡ á»•n. CÃ³ thá»ƒ Ä‘em Ä‘i trÃ­ch xuáº¥t Feature.")

def main():
    print(f"ğŸš€ Báº®T Äáº¦U QUÃ‰T DATA CÅ¨ ({INPUT_FILE})")
    
    if not os.path.exists(INPUT_FILE):
        print(f"âŒ Lá»—i: KhÃ´ng tÃ¬m tháº¥y file '{INPUT_FILE}'")
        return

    try:
        df = pd.read_csv(INPUT_FILE)
        print(f"ğŸ“š Tá»•ng data gá»‘c: {len(df):,} dÃ²ng")
    except:
        print("âŒ Lá»—i Ä‘á»c file CSV.")
        return

    data = df.to_dict('records')
    live_results = []
    
    processed = 0
    total = len(data)
    start = time.time()
    
    print("â³ Äang lá»c link sá»‘ng/cháº¿t (Max Speed)...")
    
    with concurrent.futures.ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        future_to_row = {executor.submit(check_alive, row): row for row in data}
        
        for future in concurrent.futures.as_completed(future_to_row):
            res = future.result()
            processed += 1
            if res:
                live_results.append(res)
                
            if processed % 200 == 0 or processed == total:
                percent = (processed / total) * 100
                sys.stdout.write(f"\r   â–¶ ÄÃ£ check: {processed} | ğŸŒ± Sá»‘ng: {len(live_results)} | ğŸ’€ Cháº¿t: {processed - len(live_results)}")
                sys.stdout.flush()

    print(f"\n\nâœ… XONG! Thá»i gian: {time.time() - start:.1f}s")
    
    if live_results:
        final_df = pd.DataFrame(live_results)
        final_df.to_csv(OUTPUT_FILE, index=False)
        print(f"ğŸ’¾ ÄÃ£ lÆ°u file sáº¡ch vÃ o: {OUTPUT_FILE}")
        
        # Gá»ŒI HÃ€M THá»NG KÃŠ
        analyze_stats(final_df)
        
    else:
        print("âŒ ToÃ n bá»™ link Ä‘Ã£ cháº¿t! Data nÃ y khÃ´ng dÃ¹ng Ä‘Æ°á»£c ná»¯a.")

if __name__ == "__main__":
    main()
