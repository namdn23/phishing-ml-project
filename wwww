import pandas as pd
import os

# --- Cáº¤U HÃŒNH FILE ---
FILE_LIVE_READY = 'urldata_live_ready.csv'  # File 127k dÃ²ng má»›i quÃ©t
FILE_OLD_DATA = 'old_phishing_7k.csv'      # File cÅ© (chá»©a 77k dÃ²ng thá»±c táº¿)
OUTPUT_PHISHING_ONLY = 'all_phishing_clean.csv'

def main():
    # 1. Äá»c dá»¯ liá»‡u
    print("ğŸ“‚ Äang Ä‘á»c cÃ¡c file dá»¯ liá»‡u...")
    if not os.path.exists(FILE_LIVE_READY) or not os.path.exists(FILE_OLD_DATA):
        print("âŒ Lá»—i: Thiáº¿u file Ä‘áº§u vÃ o. Kiá»ƒm tra láº¡i tÃªn file!")
        return

    df_live = pd.read_csv(FILE_LIVE_READY)
    df_old = pd.read_csv(FILE_OLD_DATA)

    # 2. Chuáº©n hÃ³a nhÃ£n (Label)
    # HÃ m nÃ y Ä‘áº£m báº£o má»i biáº¿n thá»ƒ cá»§a nhÃ£n lá»«a Ä‘áº£o Ä‘á»u vá» sá»‘ 1
    def is_phishing(l):
        l = str(l).lower().strip()
        return 1 if l in ['bad', '1', 'phishing', 'malicious'] else 0

    print("ğŸ” Äang lá»c chá»‰ láº¥y cÃ¡c URL Phishing...")
    
    # Lá»c Phishing tá»« file má»›i quÃ©t
    df_live['is_phish'] = df_live['label'].apply(is_phishing)
    phish_new = df_live[df_live['is_phish'] == 1].copy()

    # Lá»c Phishing tá»« file cÅ©
    df_old['is_phish'] = df_old['label'].apply(is_phishing)
    phish_old = df_old[df_old['is_phish'] == 1].copy()

    # 3. Gá»™p láº¡i vÃ  xÃ³a trÃ¹ng láº·p
    # Viá»‡c xÃ³a trÃ¹ng láº·p (drop_duplicates) ráº¥t quan trá»ng Ä‘á»ƒ trÃ¡nh Model há»c váº¹t
    print("ğŸ”— Äang gá»™p vÃ  loáº¡i bá» URL trÃ¹ng láº·p...")
    df_combined = pd.concat([phish_new, phish_old], ignore_index=True)
    
    # Giá»¯ láº¡i cÃ¡c cá»™t cáº§n thiáº¿t (url vÃ  label)
    df_combined = df_combined[['url', 'label']]
    
    # XÃ³a trÃ¹ng dá»±a trÃªn cá»™t 'url'
    before_count = len(df_combined)
    df_combined.drop_duplicates(subset=['url'], inplace=True)
    after_count = len(df_combined)

    # 4. LÆ°u káº¿t quáº£
    df_combined.to_csv(OUTPUT_PHISHING_ONLY, index=False)

    print("-" * 50)
    print(f"ğŸ“Š Káº¾T QUáº¢ Lá»ŒC PHISHING:")
    print(f"   + Phishing tá»« file má»›i: {len(phish_new):,}")
    print(f"   + Phishing tá»« file cÅ©:  {len(phish_old):,}")
    print(f"   + Tá»•ng sau gá»™p:         {before_count:,}")
    print(f"   + Sau khi xÃ³a trÃ¹ng:    {after_count:,}")
    print(f"ğŸ’¾ File Ä‘Ã£ lÆ°u: {OUTPUT_PHISHING_ONLY}")
    print("-" * 50)
    print("ğŸš€ Tiáº¿p theo: Báº¡n cÃ³ thá»ƒ dÃ¹ng file nÃ y Ä‘á»ƒ gá»™p vá»›i táº­p Legit nháº±m cÃ¢n báº±ng dá»¯ liá»‡u.")

if __name__ == "__main__":
    main()
