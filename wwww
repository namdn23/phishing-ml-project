import pandas as pd
import os

# Cáº¥u hÃ¬nh file
ORIGINAL_FILE = 'PhiUSIIL_Phishing_URL_Dataset.csv'
CHECKPOINT_FILE = 'extraction_checkpoint.csv'
FINAL_OUTPUT = 'PhiUSIIL_Final_Dataset_Clean.csv'

# Danh sÃ¡ch 11 cá»™t báº¡n yÃªu cáº§u tá»« file gá»‘c
KEEP_COLS_ORIGINAL = [
    'URL', 'NoOfDegitsInURL', 'HasDescription', 'HasSocialNet', 'HasPasswordField', 
    'HasSubmitButton', 'HasExternalFormSubmit', 'DomainTitleMatchScore', 
    'IsHTTPS', 'HasCopyrightInfo', 'label'
]

def final_merge():
    print("ğŸš€ Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh gá»™p dá»¯ liá»‡u cuá»‘i cÃ¹ng...")

    if not os.path.exists(CHECKPOINT_FILE):
        print("âŒ KhÃ´ng tÃ¬m tháº¥y file checkpoint. HÃ£y kiá»ƒm tra láº¡i tÃªn file!"); return

    # 1. Äá»c Checkpoint (Chá»©a V1-V23)
    print("ğŸ“‚ Äang náº¡p dá»¯ liá»‡u tá»« Checkpoint...")
    df_check = pd.read_csv(CHECKPOINT_FILE)
    df_check = df_check.drop_duplicates('URL_KEY')
    print(f"âœ”ï¸ ÄÃ£ láº¥y {len(df_check)} dÃ²ng tá»« quÃ¡ trÃ¬nh trÃ­ch xuáº¥t.")

    # 2. Äá»c file gá»‘c (Chá»‰ láº¥y 11 cá»™t má»¥c tiÃªu)
    print("ğŸ“‚ Äang náº¡p 11 cá»™t má»¥c tiÃªu tá»« file gá»‘c...")
    try:
        df_raw = pd.read_csv(ORIGINAL_FILE, usecols=KEEP_COLS_ORIGINAL)
    except Exception as e:
        print(f"âŒ Lá»—i: File gá»‘c thiáº¿u cá»™t hoáº·c khÃ´ng tá»“n táº¡i. Chi tiáº¿t: {e}"); return

    # 3. Gá»™p (Merge)
    print("ğŸ”— Äang káº¿t há»£p Ä‘áº·c trÆ°ng gá»‘c vÃ  Ä‘áº·c trÆ°ng má»›i...")
    df_final = pd.merge(df_raw, df_check, left_on='URL', right_on='URL_KEY', how='inner')

    # 4. Loáº¡i bá» cá»™t thá»«a URL_KEY
    df_final = df_final.drop(columns=['URL_KEY'])

    # 5. Xuáº¥t file
    df_final.to_csv(FINAL_OUTPUT, index=False)
    
    print("-" * 40)
    print(f"ğŸ‰ THÃ€NH CÃ”NG Rá»°C Rá» !")
    print(f"ğŸ“ File káº¿t quáº£: {FINAL_OUTPUT}")
    print(f"ğŸ“Š KÃ­ch thÆ°á»›c: {df_final.shape[0]} dÃ²ng x {df_final.shape[1]} cá»™t")
    print(f"ğŸ’¡ Tá»· lá»‡ hoÃ n thÃ nh: {(len(df_final)/len(df_raw))*100:.2f}%")
    print("-" * 40)

if __name__ == "__main__":
    final_merge()
