import pandas as pd
import os

# --- Cáº¤U HÃŒNH FILE ---
FILE_LIVE_READY = 'urldata_live_ready.csv'  # File 127k dÃ²ng vá»«a quÃ©t xong
FILE_OLD_PHISHING = 'old_phishing_7k.csv'   # File 7k phishing cÅ© cá»§a báº¡n
OUTPUT_FINAL = 'urldata_balanced_final.csv' # File cuá»‘i cÃ¹ng Ä‘á»ƒ Ä‘i trÃ­ch xuáº¥t 27 features

def main():
    # 1. Load dá»¯ liá»‡u
    print("ğŸ“‚ Äang Ä‘á»c cÃ¡c file dá»¯ liá»‡u...")
    df_live = pd.read_csv(FILE_LIVE_READY)
    
    if os.path.exists(FILE_OLD_PHISHING):
        df_old = pd.read_csv(FILE_OLD_PHISHING)
    else:
        print(f"âŒ KhÃ´ng tÃ¬m tháº¥y file {FILE_OLD_PHISHING}")
        return

    # 2. Äá»“ng nháº¥t nhÃ£n (Label) vá» dáº¡ng sá»‘: 0 (Sáº¡ch), 1 (Báº©n)
    def clean_label(l):
        l = str(l).lower()
        if l in ['bad', '1', 'phishing', 'malicious']: return 1
        return 0

    df_live['label'] = df_live['label'].apply(clean_label)
    df_old['label'] = df_old['label'].apply(clean_label)

    # 3. Lá»c riÃªng Phishing vÃ  Legit tá»« file má»›i quÃ©t
    df_live_phishing = df_live[df_live['label'] == 1]
    df_live_legit = df_live[df_live['label'] == 0]

    # 4. Gá»™p toÃ n bá»™ Phishing (Má»›i + CÅ©) vÃ  xÃ³a trÃ¹ng láº·p URL
    print("ğŸ”— Äang gá»™p dá»¯ liá»‡u Phishing...")
    df_all_phishing = pd.concat([df_live_phishing, df_old]).drop_duplicates(subset=['url'])
    
    num_phishing = len(df_all_phishing)
    print(f"âœ… Tá»•ng sá»‘ Phishing sau khi gá»™p: {num_phishing:,}")

    # 5. CÃ‚N Báº°NG Dá»® LIá»†U (BÃ­ kÃ­p Ä‘á»ƒ Model khÃ´n)
    # Náº¿u láº¥y 100% Legit (109k) thÃ¬ sáº½ ráº¥t lá»‡ch. 
    # NhÃ³m em nÃªn láº¥y tá»‰ lá»‡ 1:1.5 hoáº·c 1:2 Ä‘á»ƒ Model vá»«a giá»i báº¯t Phishing vá»«a Ã­t bÃ¡o nháº§m.
    print(f"âš–ï¸ Äang láº¥y máº«u dá»¯ liá»‡u Legit Ä‘á»ƒ cÃ¢n báº±ng...")
    num_legit_to_take = int(num_phishing * 1.5) # Láº¥y gáº¥p 1.5 láº§n phishing
    
    if num_legit_to_take > len(df_live_legit):
        num_legit_to_take = len(df_live_legit)
        
    df_legit_sampled = df_live_legit.sample(n=num_legit_to_take, random_state=42)

    # 6. Gá»™p láº¡i thÃ nh file cuá»‘i cÃ¹ng
    df_final = pd.concat([df_all_phishing, df_legit_sampled]).sample(frac=1, random_state=42) # Trá»™n ngáº«u nhiÃªn

    # 7. LÆ°u file
    df_final.to_csv(OUTPUT_FINAL, index=False)
    
    print("-" * 50)
    print(f"ğŸ“Š THá»NG KÃŠ FILE CUá»I CÃ™NG:")
    print(f"ğŸŸ¢ Legit (Sáº¡ch):   {len(df_legit_sampled):,}")
    print(f"ğŸ”´ Phishing (Báº©n): {len(df_all_phishing):,}")
    print(f"ğŸ‘‰ Tá»•ng cá»™ng:      {len(df_final):,} dÃ²ng")
    print(f"ğŸ’¾ ÄÃ£ lÆ°u táº¡i:     {OUTPUT_FINAL}")
    print("-" * 50)
    print("ğŸš€ Tiáº¿p theo: HÃ£y dÃ¹ng file nÃ y cháº¡y tool 'TrÃ­ch xuáº¥t 27 Features'!")

if __name__ == "__main__":
    main()
