import pandas as pd
import os

# --- Cáº¤U HÃŒNH FILE ---
FILE_NEW = 'urldata_live_ready.csv'   # File má»›i (127k dÃ²ng: 109k legit + 17k phish)
FILE_OLD = 'old_phishing_7k.csv'      # File cÅ© (chá»©a 7k phishing nhÃ£n 'bad')
OUTPUT_FILE = 'dataset_combined_v2.csv'

def main():
    print("ğŸ“‚ Äang Ä‘á»c dá»¯ liá»‡u...")
    if not os.path.exists(FILE_NEW) or not os.path.exists(FILE_OLD):
        print("âŒ Lá»—i: Thiáº¿u file Ä‘áº§u vÃ o!")
        return

    # 1. Äá»c file má»›i vÃ  chuáº©n hÃ³a tÃªn cá»™t
    df_new = pd.read_csv(FILE_NEW)
    # VÃ¬ áº£nh báº¡n gá»­i cá»™t URL viáº¿t hoa, ta Ä‘á»•i vá» 'url' cho Ä‘á»“ng bá»™
    df_new.rename(columns={'URL': 'url'}, inplace=True)
    print(f"âœ… ÄÃ£ táº£i file má»›i: {len(df_new):,} dÃ²ng")

    # 2. Äá»c file cÅ© vÃ  CHá»ˆ Láº¤Y PHISHING
    df_old_full = pd.read_csv(FILE_OLD)
    # Lá»c láº¥y nhá»¯ng dÃ²ng nhÃ£n 'bad'
    df_old_phish = df_old_full[df_old_full['label'].astype(str).str.lower() == 'bad'].copy()
    # Äá»•i nhÃ£n 'bad' thÃ nh sá»‘ 1 cho giá»‘ng file má»›i
    df_old_phish['label'] = 1
    print(f"âœ… ÄÃ£ lá»c tá»« file cÅ©: {len(df_old_phish):,} link phishing")

    # 3. Gá»™p file má»›i (nguyÃªn váº¹n) + phishing file cÅ©
    print("ğŸ”— Äang tiáº¿n hÃ nh gá»™p...")
    df_combined = pd.concat([df_new, df_old_phish], ignore_index=True)

    # 4. XÃ³a trÃ¹ng láº·p URL
    # (Náº¿u má»™t link phishing Ä‘Ã£ cÃ³ á»Ÿ file má»›i rá»“i thÃ¬ khÃ´ng thÃªm báº£n trÃ¹ng tá»« file cÅ© ná»¯a)
    before_count = len(df_combined)
    df_combined.drop_duplicates(subset=['url'], keep='first', inplace=True)
    after_count = len(df_combined)

    # 5. Thá»‘ng kÃª vÃ  lÆ°u
    df_combined.to_csv(OUTPUT_FILE, index=False)
    
    # Äáº¿m sá»‘ lÆ°á»£ng cuá»‘i cÃ¹ng
    final_legit = len(df_combined[df_combined['label'].astype(str) == '0'])
    final_phish = len(df_combined[df_combined['label'].astype(str) == '1'])

    print("-" * 50)
    print(f"ğŸ“Š THá»NG KÃŠ Káº¾T QUáº¢:")
    print(f"ğŸŸ¢ Legit (giá»¯ nguyÃªn): {final_legit:,}")
    print(f"ğŸ”´ Phishing (tá»•ng há»£p): {final_phish:,}")
    print(f"âœ¨ Tá»•ng cá»™ng file má»›i: {len(df_combined):,} dÃ²ng")
    print(f"â™»ï¸  ÄÃ£ loáº¡i bá» {before_count - after_count:,} URL bá»‹ trÃ¹ng giá»¯a 2 file.")
    print(f"ğŸ’¾ File Ä‘Ã£ lÆ°u: {OUTPUT_FILE}")
    print("-" * 50)
    print("ğŸš€ BÃ¢y giá» báº¡n cÃ³ thá»ƒ dÃ¹ng file nÃ y Ä‘á»ƒ trÃ­ch xuáº¥t 27 features!")

if __name__ == "__main__":
    main()
