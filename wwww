import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report, accuracy_score, confusion_matrix

# --- C·∫§U H√åNH ---
# ƒê·ªïi t√™n file n√†y th√†nh file b·∫°n v·ª´a s·ª≠a xong (VD: DATA_TRAIN_ULTIMATE.csv)
DATA_FILE = 'DATA_TRAIN_ULTIMATE.csv' 

def main():
    print("üìä ƒêANG T·∫¢I D·ªÆ LI·ªÜU ƒê·ªÇ KI·ªÇM TRA...")
    try:
        df = pd.read_csv(DATA_FILE)
        print(f"‚úÖ ƒê√£ t·∫£i: {len(df)} d√≤ng.")
    except Exception as e:
        print(f"‚ùå L·ªói: {e}")
        return

    # --- 1. KI·ªÇM TRA: D·ªÆ LI·ªÜU ƒê·ªòNG C·ª¶A √îNG L·ªöN ---
    # M·ª•c ti√™u: Ch·ª©ng minh Google/FB kh√¥ng c√≤n b·ªã to√†n s·ªë 0
    print("\n" + "="*60)
    print("üîç KI·ªÇM TRA 1: H·ªíI SINH D·ªÆ LI·ªÜU (IMPUTATION CHECK)")
    print("-" * 60)
    
    # L·ªçc ra c√°c d√≤ng Google/Facebook (D·ª±a tr√™n URL n·∫øu c√≥, ho·∫∑c ƒëo√°n)
    if 'url' in df.columns:
        google_rows = df[df['url'].str.contains('google.com', na=False, case=False)]
        print(f"   - T√¨m th·∫•y {len(google_rows)} d√≤ng ch·ª©a 'google.com'")
        
        if len(google_rows) > 0:
            avg_iframe = google_rows['Total_IFrames'].mean()
            avg_hidden = google_rows['Has_Hidden_IFrame'].mean()
            print(f"   - Trung b√¨nh Iframe c·ªßa Google: {avg_iframe:.2f} (K·ª≥ v·ªçng > 0)")
            print(f"   - Trung b√¨nh Hidden Iframe:     {avg_hidden:.2f} (K·ª≥ v·ªçng = 0, v√¨ ƒë√£ ƒë∆∞·ª£c tha)")
            
            if avg_iframe > 0:
                print("   => ‚úÖ TH√ÄNH C√îNG: D·ªØ li·ªáu Google ƒë√£ ƒë∆∞·ª£c h·ªìi sinh!")
            else:
                print("   => ‚ùå TH·∫§T B·∫†I: D·ªØ li·ªáu Google v·∫´n b·∫±ng 0. Ki·ªÉm tra l·∫°i code s·ª≠a.")
    else:
        print("   (Kh√¥ng t√¨m th·∫•y c·ªôt 'url' ƒë·ªÉ ki·ªÉm tra c·ª• th·ªÉ, b·ªè qua b∆∞·ªõc n√†y)")

    # --- 2. KI·ªÇM TRA: PH√ÇN B·ªê D·ªÆ LI·ªÜU (DATA DISTRIBUTION) ---
    print("\n" + "="*60)
    print("üîç KI·ªÇM TRA 2: S·ª∞ KH√ÅC BI·ªÜT GI·ªÆA TH·∫¨T (0) V√Ä GI·∫¢ (1)")
    print("-" * 60)
    
    # Ch·ªâ l·∫•y c√°c c·ªôt s·ªë
    numeric_cols = df.select_dtypes(include=[np.number]).columns
    
    # So s√°nh trung b√¨nh c·ªßa m·ªôt s·ªë Feature quan tr·ªçng
    check_feats = ['Total_IFrames', 'Has_External_Form', 'Brand_In_Subdomain', 'Certificate_Age']
    
    print(f"{'FEATURE':<25} | {'SAFE (0)':<10} | {'PHISHING (1)':<12} | {'NH·∫¨N X√âT'}")
    print("-" * 65)
    
    for col in check_feats:
        if col in df.columns:
            mean_safe = df[df['label']==0][col].mean()
            mean_phish = df[df['label']==1][col].mean()
            
            diff = "Gi·ªëng nhau"
            if mean_safe > mean_phish * 1.5: diff = "Safe > Phish"
            if mean_phish > mean_safe * 1.5: diff = "Phish > Safe"
            
            print(f"{col:<25} | {mean_safe:<10.4f} | {mean_phish:<12.4f} | {diff}")

    # --- 3. HU·∫§N LUY·ªÜN TH·ª¨ & ƒê√ÅNH GI√Å (MODEL EVALUATION) ---
    print("\n" + "="*60)
    print("ü§ñ KI·ªÇM TRA 3: HU·∫§N LUY·ªÜN TH·ª¨ & FEATURE IMPORTANCE")
    print("-" * 60)
    
    # Chu·∫©n b·ªã d·ªØ li·ªáu
    drop_cols = ['url', 'label', 'temp_idx']
    X = df.drop(columns=[c for c in drop_cols if c in df.columns], errors='ignore')
    y = df['label']
    
    # Split
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
    
    # Train Random Forest (Nhanh v√† m·∫°nh)
    rf = RandomForestClassifier(n_estimators=50, random_state=42)
    rf.fit(X_train, y_train)
    
    # Predict
    y_pred = rf.predict(X_test)
    acc = accuracy_score(y_test, y_pred)
    
    print(f"‚úÖ Accuracy (ƒê·ªô ch√≠nh x√°c): {acc:.2%}")
    print("\nüìä B·∫¢NG X·∫æP H·∫†NG ƒê·∫∂C TR∆ØNG QUAN TR·ªåNG NH·∫§T:")
    
    # L·∫•y Feature Importance
    importances = rf.feature_importances_
    indices = np.argsort(importances)[::-1]
    
    print(f"{'RANK':<5} | {'FEATURE NAME':<30} | {'IMPORTANCE'}")
    print("-" * 50)
    
    for f in range(min(20, len(X.columns))): # Top 20
        idx = indices[f]
        print(f"{f+1:<5} | {X.columns[idx]:<30} | {importances[idx]:.4f}")
        
    print("-" * 50)
    
    # Check xem Dynamic Feature c√≥ ngoi l√™n kh√¥ng
    dynamic_feats = ['Total_IFrames', 'Has_Hidden_IFrame', 'Has_External_Form']
    print("\nüëÄ V·ªä TR√ç C·ª¶A C√ÅC ƒê·∫∂C TR∆ØNG ƒê·ªòNG:")
    for feat in dynamic_feats:
        if feat in X.columns:
            rank = list(X.columns[indices]).index(feat) + 1
            print(f"   - {feat}: H·∫°ng {rank}/{len(X.columns)}")

if __name__ == "__main__":
    main()
