import pandas as pd
import requests
from concurrent.futures import ThreadPoolExecutor, as_completed
from tqdm import tqdm
import time

# --- C·∫§U H√åNH ---
INPUT_FILE = 'final_train_dataset_v9_4_fixed.csv' # File ƒë√£ g·ªôp Domain Age
OUTPUT_FILE = 'dataset_final_with_redirect.csv'
MAX_WORKERS = 20  # C√≥ th·ªÉ ƒë·ªÉ cao (20-30) v√¨ ch·ªâ check header, r·∫•t nh·∫π CPU
TIMEOUT = 5       # Link n√†o sau 5s kh√¥ng h·ªìi ƒë√°p th√¨ b·ªè qua cho nhanh

def check_is_redirected(url):
    """Ki·ªÉm tra xem URL c√≥ b·ªã redirect ƒë·∫øn domain kh√°c kh√¥ng"""
    try:
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
        # allow_redirects=True ƒë·ªÉ requests t·ª± ƒëu·ªïi theo ƒë·∫øn ƒë√≠ch cu·ªëi c√πng
        response = requests.head(url, headers=headers, allow_redirects=True, timeout=TIMEOUT)
        
        final_url = response.url.strip('/')
        original_url = url.strip('/')
        
        # So s√°nh URL cu·ªëi c√πng v·ªõi URL ban ƒë·∫ßu
        if final_url != original_url:
            return 1
        return 0
    except:
        # N·∫øu link ch·∫øt, timeout ho·∫∑c l·ªói DNS, tr·∫£ v·ªÅ -1 (ƒë√°nh d·∫•u d·ªØ li·ªáu l·ªói)
        return -1

def process_row(row_data):
    index, url = row_data
    result = check_is_redirected(url)
    return index, result

def main():
    # 1. Load Data
    df = pd.read_csv(INPUT_FILE)
    
    # Kh·ªüi t·∫°o c·ªôt n·∫øu ch∆∞a c√≥
    if 'Is_Redirected' not in df.columns:
        df['Is_Redirected'] = -2 # -2 nghƒ©a l√† ch∆∞a x·ª≠ l√Ω

    # L·ªçc danh s√°ch c·∫ßn qu√©t (b·ªè qua nh·ªØng c√°i ƒë√£ c√≥ k·∫øt qu·∫£ ho·∫∑c link l·ªói)
    to_process = df[df['Is_Redirected'] == -2]
    tasks = [(idx, row['url']) for idx, row in to_process.iterrows()]

    print(f"üöÄ ƒêang qu√©t Redirect cho {len(tasks)} m·∫´u v·ªõi {MAX_WORKERS} lu·ªìng...")
    

    # 2. Ch·∫°y ƒëa lu·ªìng
    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        futures = {executor.submit(process_row, task): task for task in tasks}
        
        for i, future in enumerate(tqdm(as_completed(futures), total=len(futures))):
            index, result = future.result()
            df.at[index, 'Is_Redirected'] = result
            
            # L∆∞u m·ªói 500 d√≤ng cho an to√†n
            if i > 0 and i % 500 == 0:
                df.to_csv(OUTPUT_FILE, index=False)

    # 3. K·∫øt th√∫c
    df.to_csv(OUTPUT_FILE, index=False)
    print(f"‚úÖ ƒê√£ tr√≠ch xu·∫•t xong ƒë·∫∑c tr∆∞ng Is_Redirected!")

if __name__ == "__main__":
    main()
