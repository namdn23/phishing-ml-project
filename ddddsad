import pandas as pd
import numpy as np

# --- Cáº¤U HÃŒNH ---
FILE_PATH = 'dataset_final_train_fixed.csv' # File Ä‘Ã£ vÃ¡ lá»—i SSL

def final_audit():
    print(f"ğŸ•µï¸ ÄANG KIá»‚M TRA TOÃ€N DIá»†N 29 Cá»˜T Dá»® LIá»†U...")
    print("="*70)

    try:
        df = pd.read_csv(FILE_PATH)
    except:
        print(f"âŒ KhÃ´ng tÃ¬m tháº¥y file {FILE_PATH}")
        return

    # 1. KIá»‚M TRA Dá»® LIá»†U RÃC (NULL / INFINITY)
    print("\nğŸ§¹ 1. KIá»‚M TRA Dá»® LIá»†U Rá»–NG/Lá»–I:")
    null_counts = df.isnull().sum().sum()
    if null_counts > 0:
        print(f"âš ï¸  Cáº¢NH BÃO: CÃ³ {null_counts} Ã´ bá»‹ trá»‘ng (NaN). Cáº§n Ä‘iá»n 0 hoáº·c xÃ³a.")
    else:
        print("âœ… Dá»¯ liá»‡u sáº¡ch, khÃ´ng cÃ³ Ã´ trá»‘ng.")

    # 2. KIá»‚M TRA CÃC TÃNH NÄ‚NG "CHáº¾T" (ZERO VARIANCE)
    # TÃ­nh nÄƒng cháº¿t lÃ  tÃ­nh nÄƒng mÃ  má»i dÃ²ng Ä‘á»u cÃ³ giÃ¡ trá»‹ y há»‡t nhau -> AI khÃ´ng há»c Ä‘Æ°á»£c gÃ¬.
    print("\nğŸ’€ 2. KIá»‚M TRA TÃNH NÄ‚NG 'CHáº¾T' (VÃ´ dá»¥ng):")
    dead_features = []
    for col in df.columns:
        if col in ['url', 'label']: continue
        if df[col].nunique() <= 1:
            val = df[col].iloc[0]
            print(f"   âŒ Cá»™t '{col}': ToÃ n bá»™ giÃ¡ trá»‹ lÃ  {val} -> NÃŠN XÃ“A")
            dead_features.append(col)
            
    if not dead_features:
        print("âœ… Tuyá»‡t vá»i! Má»i tÃ­nh nÄƒng Ä‘á»u cÃ³ sá»± biáº¿n thiÃªn (cÃ³ Ã­ch).")

    # 3. KIá»‚M TRA HIá»†U QUáº¢ Cá»¦A SSL (Sau khi Ä‘Ã£ fix)
    print("\nğŸ›¡ï¸ 3. KIá»‚M TRA HIá»†U QUáº¢ SSL (Sau khi fix):")
    ssl_ok = len(df[df['Certificate_Age'] != -1])
    ssl_fail = len(df) - ssl_ok
    print(f"   - âœ… Láº¥y Ä‘Æ°á»£c SSL: {ssl_ok:,} dÃ²ng ({ssl_ok/len(df)*100:.1f}%)")
    print(f"   - âŒ Váº«n lá»—i (-1): {ssl_fail:,} dÃ²ng")
    
    if ssl_ok == 0:
        print("   âš ï¸  Cáº¢NH BÃO: Váº«n chÆ°a láº¥y Ä‘Æ°á»£c SSL nÃ o. Kiá»ƒm tra láº¡i máº¡ng/code.")

    # 4. PHÃ‚N TÃCH TÆ¯Æ NG QUAN (CORRELATION)
    # Xem tÃ­nh nÄƒng nÃ o giÃºp AI phÃ¡t hiá»‡n Phishing tá»‘t nháº¥t
    print("\nww 4. TOP 10 TÃNH NÄ‚NG QUAN TRá»ŒNG NHáº¤T (TÆ°Æ¡ng quan vá»›i Label):")
    # Chá»‰ láº¥y cÃ¡c cá»™t sá»‘
    numeric_df = df.select_dtypes(include=[np.number])
    if 'label' in numeric_df.columns:
        correlations = numeric_df.corr()['label'].abs().sort_values(ascending=False)
        # Bá» qua dÃ²ng label tá»± tÆ°Æ¡ng quan vá»›i chÃ­nh nÃ³
        top_10 = correlations.drop('label').head(10)
        
        for feature, score in top_10.items():
            print(f"   â˜… {feature.ljust(25)}: {score:.4f} (Äá»™ máº¡nh)")
    
    print("\n" + "="*70)
    print("ğŸ“¢ Káº¾T LUáº¬N:")
    if dead_features:
        print(f"âš ï¸  Cáº§n xÃ³a {len(dead_features)} cá»™t vÃ´ dá»¥ng trÆ°á»›c khi train.")
    elif ssl_ok < 1000:
        print("âš ï¸  Dá»¯ liá»‡u SSL quÃ¡ Ã­t, Model sáº½ chá»§ yáº¿u dá»±a vÃ o URL.")
    else:
        print("ğŸš€ Bá»˜ Dá»® LIá»†U Ráº¤T Tá»T! Sáº´N SÃ€NG Äá»‚ TRAIN.")

if __name__ == "__main__":
    final_audit()
