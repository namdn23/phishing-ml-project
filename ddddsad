import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt

# --- Cáº¤U HÃŒNH ---
# HÃ£y thay báº±ng tÃªn file má»›i nháº¥t cá»§a báº¡n (file fixed hoáº·c file gá»‘c)
FILE_PATH = 'dataset_final_train_fixed.csv' 

def analyze_all_features():
    print(f"ğŸ•µï¸ Báº®T Äáº¦U PHÃ‚N TÃCH TOÃ€N Bá»˜ 29 FEATURES...")
    print("="*80)

    try:
        df = pd.read_csv(FILE_PATH)
    except:
        print(f"âŒ KhÃ´ng tÃ¬m tháº¥y file {FILE_PATH}")
        return

    # 1. TÃCH Dá»® LIá»†U
    # Bá» cá»™t URL vÃ¬ nÃ³ lÃ  text, khÃ´ng tÃ­nh toÃ¡n thá»‘ng kÃª Ä‘Æ°á»£c
    if 'url' in df.columns:
        df_numeric = df.drop(columns=['url'])
    else:
        df_numeric = df

    # 2. TÃŒM FEATURE "CHáº¾T" (Constant Columns)
    # Feature cháº¿t lÃ  feature mÃ  táº¥t cáº£ cÃ¡c dÃ²ng Ä‘á»u cÃ³ giÃ¡ trá»‹ giá»‘ng há»‡t nhau -> VÃ´ dá»¥ng
    print("\nğŸ’€ DANH SÃCH FEATURE 'CHáº¾T' (Cáº§n xÃ³a bá»):")
    dead_features = []
    for col in df_numeric.columns:
        if df_numeric[col].nunique() <= 1:
            val = df_numeric[col].iloc[0]
            print(f"   âŒ {col.ljust(30)}: GiÃ¡ trá»‹ duy nháº¥t lÃ  {val}")
            dead_features.append(col)
    
    if not dead_features:
        print("   âœ… KhÃ´ng cÃ³ feature nÃ o cháº¿t hoÃ n toÃ n!")

    # 3. KIá»‚M TRA Äá»˜ QUAN TRá»ŒNG (CORRELATION MATRIX)
    # Xem feature nÃ o tÆ°Æ¡ng quan máº¡nh nháº¥t vá»›i Label (Phishing)
    print("\nğŸ† TOP 30 FEATURE QUAN TRá»ŒNG NHáº¤T (Dá»±a trÃªn tÆ°Æ¡ng quan):")
    if 'label' in df_numeric.columns:
        # TÃ­nh tÆ°Æ¡ng quan tuyá»‡t Ä‘á»‘i
        corr = df_numeric.corrwith(df_numeric['label']).abs().sort_values(ascending=False)
        # Bá» dÃ²ng label (tÆ°Æ¡ng quan vá»›i chÃ­nh nÃ³ lÃ  1)
        top_features = corr.drop('label').head(30)
        
        for feature, score in top_features.items():
            stars = ""
            if score > 0.4: stars = "ğŸ”¥ğŸ”¥ğŸ”¥ (Cá»±c máº¡nh)"
            elif score > 0.2: stars = "ğŸ”¥ğŸ”¥ (Máº¡nh)"
            elif score > 0.1: stars = "ğŸ”¥ (KhÃ¡)"
            else: stars = "(Trung bÃ¬nh)"
            
            print(f"   â˜… {feature.ljust(30)}: {score:.4f} {stars}")

    # 4. KIá»‚M TRA SSL Cá»¤ THá»‚
    print("\nğŸ›¡ï¸ TÃŒNH TRáº NG SSL:")
    if 'Certificate_Age' in df.columns:
        ssl_fail_count = len(df[df['Certificate_Age'] == -1])
        print(f"   - Sá»‘ dÃ²ng bá»‹ lá»—i SSL (-1): {ssl_fail_count:,} / {len(df):,} dÃ²ng")
        if ssl_fail_count == len(df):
            print("   âš ï¸  Káº¾T LUáº¬N: SSL há»ng toÃ n bá»™ -> Sáº½ bá»‹ xÃ³a khi train.")
        else:
            print("   âœ… Káº¾T LUáº¬N: ÄÃ£ cá»©u Ä‘Æ°á»£c má»™t pháº§n SSL.")

    # 5. Káº¾T LUáº¬N CUá»I CÃ™NG
    print("="*80)
    print("ğŸ“¢ Lá»œI KHUYÃŠN CHO Báº N:")
    
    cols_to_drop = ['url', 'Fetch_Method'] + dead_features
    print(f"1. TrÆ°á»›c khi train, hÃ£y xÃ³a cÃ¡c cá»™t sau: {cols_to_drop}")
    print(f"2. CÃ¡c feature cÃ²n láº¡i ({len(df.columns) - len(cols_to_drop)}) Ä‘á»§ máº¡nh Ä‘á»ƒ Ä‘áº¡t Ä‘á»™ chÃ­nh xÃ¡c cao.")

if __name__ == "__main__":
    analyze_all_features()
