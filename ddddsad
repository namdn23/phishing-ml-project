import pandas as pd
import numpy as np

# --- Cáº¤U HÃŒNH ---
# DÃ¹ng file má»›i nháº¥t báº¡n vá»«a cháº¡y fix SSL xong
FILE_PATH = 'dataset_final_train_fixed.csv' 

def audit_everything():
    print(f"ğŸ•µï¸ Báº®T Äáº¦U KIá»‚M TRA TOÃ€N Bá»˜ CÃC Cá»˜T Dá»® LIá»†U...")
    print("="*80)

    try:
        df = pd.read_csv(FILE_PATH)
        # Loáº¡i bá» cá»™t URL náº¿u cÃ²n, Ä‘á»ƒ chá»‰ tÃ­nh toÃ¡n trÃªn sá»‘
        if 'url' in df.columns:
            df_numeric = df.drop(columns=['url'])
        else:
            df_numeric = df
    except Exception as e:
        print(f"âŒ Lá»—i Ä‘á»c file: {e}")
        return

    # 1. KIá»‚M TRA TÃNH NÄ‚NG CHáº¾T (ZERO VARIANCE)
    # Náº¿u má»™t cá»™t mÃ  táº¥t cáº£ cÃ¡c dÃ²ng Ä‘á»u cÃ³ giÃ¡ trá»‹ y há»‡t nhau -> AI khÃ´ng há»c Ä‘Æ°á»£c gÃ¬ -> NÃŠN XÃ“A
    print("\nğŸ’€ 1. DANH SÃCH TÃNH NÄ‚NG 'CHáº¾T' (Cáº§n xÃ³a):")
    dead_features = []
    
    for col in df_numeric.columns:
        if col == 'label': continue
        
        unique_vals = df_numeric[col].unique()
        if len(unique_vals) == 1:
            print(f"   âŒ {col.ljust(30)}: GiÃ¡ trá»‹ duy nháº¥t lÃ  {unique_vals[0]}")
            dead_features.append(col)
    
    if not dead_features:
        print("   âœ… Tuyá»‡t vá»i! KhÃ´ng cÃ³ tÃ­nh nÄƒng nÃ o bá»‹ cháº¿t hoÃ n toÃ n.")

    # 2. KIá»‚M TRA CÃC NHÃ“M TÃNH NÄ‚NG Cá»¤ THá»‚
    print("-" * 80)
    print("\nğŸ” 2. KIá»‚M TRA CHI TIáº¾T Tá»ªNG NHÃ“M:")

    # --- NhÃ³m A: URL Structure ---
    print("\n   [A] Cáº¥u trÃºc URL (Static Features):")
    url_feats = ['Domain_Length', 'Path_Length', 'Num_Dots', 'Digit_Ratio', 'Entropy_Subdomain']
    for f in url_feats:
        if f in df.columns:
            avg = df[f].mean()
            print(f"       - {f.ljust(25)}: Trung bÃ¬nh = {avg:.4f} (á»”n)")

    # --- NhÃ³m B: SSL (Infrastructure) ---
    print("\n   [B] Háº¡ táº§ng SSL (Dynamic Features):")
    ssl_ok = len(df[df['Certificate_Age'] > 0])
    ssl_fail = len(df[df['Certificate_Age'] == -1])
    print(f"       - Dá»¯ liá»‡u SSL há»£p lá»‡: {ssl_ok:,} dÃ²ng")
    print(f"       - Dá»¯ liá»‡u SSL bá»‹ lá»—i (-1): {ssl_fail:,} dÃ²ng")
    if ssl_ok == 0:
        print("       âš ï¸  Cáº¢NH BÃO: NhÃ³m nÃ y coi nhÆ° Há»NG TOÃ€N Bá»˜.")

    # --- NhÃ³m C: Ná»™i dung HTML (Content Features) ---
    print("\n   [C] Ná»™i dung HTML (Dynamic Features):")
    html_feats = ['Has_External_Form', 'Has_Submit_Button', 'Has_Password_Field', 'Brand_Impersonation']
    for f in html_feats:
        if f in df.columns:
            count_1 = len(df[df[f] == 1])
            print(f"       - {f.ljust(25)}: TÃ¬m tháº¥y {count_1:,} trang cÃ³ dáº¥u hiá»‡u nÃ y.")

    # 3. TOP TÃNH NÄ‚NG QUAN TRá»ŒNG NHáº¤T (CORRELATION)
    print("-" * 80)
    print("\nğŸ† 3. TOP 10 TÃNH NÄ‚NG Máº NH NHáº¤T (AI sáº½ dá»±a vÃ o Ä‘Ã¢y Ä‘á»ƒ báº¯t Phishing):")
    print("(GiÃ¡ trá»‹ cÃ ng gáº§n 1.0 hoáº·c -1.0 thÃ¬ cÃ ng quan trá»ng)")
    
    if 'label' in df_numeric.columns:
        corr = df_numeric.corrwith(df_numeric['label']).abs().sort_values(ascending=False)
        top_10 = corr.drop('label').head(10)
        
        for feature, score in top_10.items():
            # ÄÃ¡nh giÃ¡ sÆ¡ bá»™
            strength = "Yáº¿u"
            if score > 0.5: strength = "Cá»°C Máº NH ğŸ”¥"
            elif score > 0.3: strength = "Máº¡nh ğŸ’ª"
            elif score > 0.1: strength = "KhÃ¡ ğŸ†—"
            
            print(f"   â˜… {feature.ljust(30)}: {score:.4f} ({strength})")

    # 4. Káº¾T LUáº¬N CUá»I CÃ™NG
    print("="*80)
    print("ğŸ“¢ Káº¾T LUáº¬N TÆ¯ Váº¤N:")
    
    recommendation = "TRAIN ÄÆ¯á»¢C NGAY"
    
    if dead_features:
        print(f"1. Báº¡n Cáº¦N XÃ“A {len(dead_features)} cá»™t cháº¿t Ä‘Ã£ liá»‡t kÃª á»Ÿ má»¥c 1.")
        recommendation = "Cáº¦N Dá»ŒN Dáº¸P TRÆ¯á»šC KHI TRAIN"
        
    if ssl_ok == 0:
        print("2. SSL váº«n há»ng hoÃ n toÃ n. Model sáº½ bá» qua SSL.")
    else:
        print(f"2. ÄÃ£ cá»©u Ä‘Æ°á»£c {ssl_ok} dÃ²ng SSL. Model sáº½ thÃ´ng minh hÆ¡n!")
        
    print(f"\nğŸ‘‰ ÄÃNH GIÃ: {recommendation}")

if __name__ == "__main__":
    audit_everything()
